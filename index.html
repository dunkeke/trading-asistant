<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v5.9 (ä¿®å¤å¯¼å…¥å¯¼å‡ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Simple modal styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;
        }
        .search-input {
             width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0;
             border-radius: 0.375rem; margin-bottom: 1rem;
        }
        /* Style for reversed logs */
        .reversed-log {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .report-text {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
        .otc-badge {
            background-color: #fbbf24;
            color: #92400e;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            margin-left: 0.3rem;
            font-weight: 600;
        }
        .scn-badge {
            background-color: #dbeafe;
            color: #1e40af;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            margin-left: 0.3rem;
            font-weight: 600;
        }
        .position-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .position-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v5.9</h1>
            <p class="text-gray-600 mt-2">ä¿®å¤å¯¼å…¥å¯¼å‡ºç‰ˆï¼šåŠŸèƒ½å…¨é¢æ¢å¤</p>
            <div class="mt-4 flex flex-wrap justify-center gap-2">
                <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">ğŸ’ OTCä¼˜å…ˆ</span>
                <span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">ğŸ“Š Stripæ›²çº¿</span>
                <span class="bg-amber-100 text-amber-800 text-sm font-medium px-3 py-1 rounded-full">ğŸ¤– æ™ºèƒ½è§£æ</span>
                <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">ğŸ“ˆ æ•°æ®å¯¼å‡º</span>
            </div>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Controls & Input -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Trade Entry Form -->
                <div class="bg-white p-6 rounded-lg shadow-md position-card" style="border-left-color: #4f46e5;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        è®°å½•æ–°äº¤æ˜“
                    </h2>
                    
                    <!-- Batch Import Button -->
                    <button type="button" onclick="openBatchImportModal()" class="w-full mb-4 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center gap-2 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥
                    </button>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">æˆ– æ‰‹åŠ¨å½•å…¥</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <form id="trade-form" class="space-y-4">
                        <div>
                            <label for="trader" class="block text-sm font-medium text-gray-700 mb-1">äº¤æ˜“å‘˜</label>
                            <select id="trader" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option>W</option><option>L</option><option>Z</option>
                            </select>
                        </div>
                        <div>
                            <label for="product" class="block text-sm font-medium text-gray-700 mb-1">å“ç§</label>
                            <select id="product" onchange="updateContractOptions()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="Brent">Brent</option><option value="Henry Hub">Henry Hub</option>
                            </select>
                        </div>
                        <div>
                            <label for="contract" class="block text-sm font-medium text-gray-700 mb-1">åˆçº¦</label>
                            <select id="contract" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="trade-type" class="block text-sm font-medium text-gray-700 mb-1">äº¤æ˜“ç±»å‹</label>
                            <select id="trade-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="regular">å¸¸è§„äº¤æ˜“ (è®¡å…¥ç›ˆäº)</option>
                                <option value="adjustment">æˆæœ¬è°ƒæ•´ (ä¼˜åŒ–æˆæœ¬)</option>
                            </select>
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">æ•°é‡ (è´Ÿæ•°ä¸ºå–å‡º)</label>
                            <input type="number" id="quantity" step="0.001" placeholder="-10.000" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700 mb-1">æˆäº¤ä»·æ ¼</label>
                            <div class="flex items-center">
                                <input type="number" step="any" id="price" placeholder="85.500" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                <button type="button" onclick="toggleOtcPrice()" class="ml-2 mt-1 px-3 py-2 bg-amber-100 text-amber-800 rounded-md hover:bg-amber-200 text-sm font-medium">OTC</button>
                                <button type="button" onclick="toggleScnPrice()" class="ml-1 mt-1 px-3 py-2 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 text-sm font-medium">SCN</button>
                            </div>
                            <p id="price-hint" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 shadow-md">æäº¤äº¤æ˜“</button>
                    </form>
                </div>
                
                <!-- å…¨å±€è´¹ç”¨è®¾ç½® -->
                <div class="bg-white p-6 rounded-lg shadow-md position-card" style="border-left-color: #10b981;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        å…¨å±€è´¹ç”¨è®¾ç½®
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="commission-brent" class="block text-sm font-medium text-gray-700">Brent è´¹ç”¨ (per barrel)</label>
                            <input type="number" step="0.01" id="commission-brent" value="0.00" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0.01">
                        </div>
                         <div>
                            <label for="commission-hh" class="block text-sm font-medium text-gray-700">Henry Hub è´¹ç”¨ (per MMBtu)</label>
                            <input type="number" step="0.0001" id="commission-hh" value="0.0000" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0.0015">
                        </div>
                        <div>
                            <label for="exchange-rate-rmb" class="block text-sm font-medium text-gray-700">é€šç”¨æ±‡ç‡ (USD to RMB)</label>
                            <input type="number" step="0.01" id="exchange-rate-rmb" value="7.13" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="7.13">
                        </div>
                        <div>
                            <label for="initial-realized-pl" class="block text-sm font-medium text-gray-700">æœŸåˆå®ç°ç›ˆäº (USD)</label>
                            <input type="number" step="any" id="initial-realized-pl" value="0.00" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0.00">
                        </div>
                        <button type="button" onclick="saveSettings()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>

                <!-- æƒ…æ™¯åˆ†æ -->
                <div class="bg-white p-6 rounded-lg shadow-md position-card" style="border-left-color: #f59e0b;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        æƒ…æ™¯åˆ†æ / å‹åŠ›æµ‹è¯•
                    </h2>
                    <div class="space-y-4">
                        <div>
                             <label for="brent-scenario" class="block text-sm font-medium text-gray-700">Brent ä»·æ ¼å˜åŠ¨</label>
                             <input type="number" step="any" id="brent-scenario" placeholder="+5.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="hh-scenario" class="block text-sm font-medium text-gray-700">Henry Hub ä»·æ ¼å˜åŠ¨</label>
                            <input type="number" step="any" id="hh-scenario" placeholder="-0.5000" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <button type="button" onclick="runStressTest()" class="w-full bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 transition shadow-md">è®¡ç®—å½±å“</button>
                        <div id="stress-test-result" class="text-center p-3 bg-gray-100 rounded-md hidden">
                            <p class="font-semibold">é¢„ä¼°P/Lå˜åŠ¨: <span id="pl-change" class="text-lg"></span></p>
                            <p>é¢„ä¼°æ–°æ€»æµ®åŠ¨å‡€ç›ˆäº: <span id="new-total-pl" class="text-lg"></span></p>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="bg-white p-6 rounded-lg shadow-md position-card" style="border-left-color: #8b5cf6;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        æ•°æ®ç®¡ç† & æ—¥æŠ¥
                    </h2>
                    <div class="space-y-3">
                        <button type="button" onclick="exportData()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            å¯¼å‡ºå…¨éƒ¨æ•°æ® (JSON)
                        </button>
                        <div>
                            <label for="import-file" class="w-full text-center cursor-pointer bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300 block flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                </svg>
                                å¯¼å…¥æ•°æ® (JSON)
                            </label>
                            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                        </div>
                        <!-- Import Market Data Only -->
                        <div>
                            <label for="import-mtm-file" class="w-full text-center cursor-pointer bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition duration-300 block flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                </svg>
                                ğŸ“ˆ å¯¼å…¥è¡Œæƒ…æ•°æ® (JSON)
                            </label>
                            <input type="file" id="import-mtm-file" class="hidden" accept=".json" onchange="importMtmData(event)">
                        </div>

                        <button type="button" onclick="exportLedgerCSV()" class="w-full bg-blue-800 text-white py-2 px-4 rounded-md hover:bg-blue-900 transition duration-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            å¯¼å‡ºé€æ—¥å°è´¦ (CSV)
                        </button>
                        <button type="button" onclick="exportPositionsCSV()" class="w-full bg-indigo-800 text-white py-2 px-4 rounded-md hover:bg-indigo-900 transition duration-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            å¯¼å‡ºæŒä»“æ•°æ® (CSV)
                        </button>
                        <button type="button" onclick="generateDailyReport()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition duration-300 shadow-md border-l-4 border-purple-800 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            ğŸ“ ç”Ÿæˆä»Šæ—¥æ—¥æŠ¥æ‘˜è¦
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Data Display & Analysis -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Current Positions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            å½“å‰æŒä»“
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">æ€»æµ®åŠ¨ç›ˆäº: <span id="total-floating-pl-badge" class="font-bold">0.00</span></span>
                            <button type="button" onclick="exportPositionsCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                å¯¼å‡ºCSV
                            </button>
                        </div>
                    </div>
                    <input type="text" id="search-positions" onkeyup="filterTable('search-positions', 'positions-table')" placeholder="æœç´¢åˆçº¦/äº¤æ˜“å‘˜..." class="search-input">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3">äº¤æ˜“å‘˜</th>
                                    <th scope="col" class="px-4 py-3">åˆçº¦</th>
                                    <th scope="col" class="px-4 py-3">æ•°é‡</th>
                                    <th scope="col" class="px-4 py-3">å‡ä»·</th>
                                    <th scope="col" class="px-4 py-3">MTMä»·æ ¼</th>
                                    <th scope="col" class="px-4 py-3">æµ®åŠ¨å‡€P/L</th>
                                    <th scope="col" class="px-4 py-3">å¯¹åº”åˆ°å²¸ä»·</th>
                                    <th scope="col" class="px-4 py-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table"></tbody>
                            <tfoot class="font-semibold text-gray-800 bg-gray-50">
                                <tr>
                                    <td colspan="5" class="text-right px-4 py-2">æ€»è®¡</td>
                                    <td id="total-floating-pl" class="px-4 py-2">0.00</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Transaction Log -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            äº¤æ˜“æ—¥å¿—
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button type="button" onclick="exportLogCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                å¯¼å‡ºCSV
                            </button>
                            <button type="button" onclick="exportHistoryCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                å¯¼å‡ºå†å²
                            </button>
                        </div>
                    </div>
                    <input type="text" id="search-log" onkeyup="filterTable('search-log', 'log-table')" placeholder="æœç´¢åˆçº¦/äº¤æ˜“å‘˜..." class="search-input">
                    <div class="overflow-x-auto max-h-80">
                         <table class="w-full min-w-max text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3">æ—¶é—´</th>
                                    <th scope="col" class="px-4 py-3">äº¤æ˜“å‘˜</th>
                                    <th scope="col" class="px-4 py-3">åˆçº¦</th>
                                    <th scope="col" class="px-4 py-3">æ•°é‡</th>
                                    <th scope="col" class="px-4 py-3">ä»·æ ¼</th>
                                    <th scope="col" class="px-4 py-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="log-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- History -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            å†å²å¹³ä»“è®°å½•
                        </h2>
                        <button type="button" onclick="exportHistoryCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            å¯¼å‡ºCSV
                        </button>
                    </div>
                    <input type="text" id="search-history" onkeyup="filterTable('search-history', 'history-table')" placeholder="æœç´¢åˆçº¦/äº¤æ˜“å‘˜..." class="search-input">
                    <div class="overflow-x-auto max-h-80">
                         <table class="w-full min-w-max text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3">æ—¥æœŸ</th>
                                    <th scope="col" class="px-4 py-3">äº¤æ˜“å‘˜</th>
                                    <th scope="col" class="px-4 py-3">åˆçº¦</th>
                                    <th scope="col" class="px-4 py-3">å¹³ä»“é‡</th>
                                    <th scope="col" class="px-4 py-3">å¼€ä»“ä»·</th>
                                    <th scope="col" class="px-4 py-3">å¹³ä»“ä»·</th>
                                    <th scope="col" class="px-4 py-3">å®ç°å‡€P/L</th>
                                </tr>
                            </thead>
                            <tbody id="history-table"></tbody>
                             <tfoot class="font-semibold text-gray-800 bg-gray-50 sticky bottom-0">
                                <tr>
                                    <td colspan="6" class="text-right px-4 py-2">ç´¯è®¡å®ç°ç›ˆäº</td>
                                    <td id="total-realized-pl" class="px-4 py-2">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Infographics -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                        </svg>
                        Infographics æ•°æ®åˆ†æ
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">æŒä»“å¸‚å€¼ç»“æ„</h3>
                            <div class="chart-container"><canvas id="position-structure-chart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">å·²å®ç°å‡€ç›ˆäºæ›²çº¿</h3>
                            <div class="chart-container"><canvas id="realized-pl-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v5.9 | ä¿®å¤å¯¼å…¥å¯¼å‡ºç‰ˆ | æ•°æ®å®‰å…¨å¤‡ä»½å»ºè®®: æ¯æ—¥å¯¼å‡ºJSONæ–‡ä»¶</p>
            <p class="mt-1">Â© 2024 äº¤æ˜“åˆ†æç³»ç»Ÿ | æœ€åæ›´æ–°: <span id="last-update">åŠ è½½ä¸­...</span></p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="edit-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">ç¼–è¾‘æŒä»“</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-index">
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ•°é‡</label>
                    <input type="number" id="edit-quantity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">å‡ä»·</label>
                    <input type="number" step="any" id="edit-price" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="action-confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h2 id="confirm-title" class="text-xl font-semibold mb-4"></h2>
            <p id="confirm-body" class="text-gray-600 mb-6 whitespace-pre-line"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" type="button" onclick="closeActionConfirmModal()" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">å–æ¶ˆ</button>
                <button id="confirm-action-btn" type="button" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- Daily Report Modal -->
    <div id="report-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">ä»Šæ—¥æ—¥æŠ¥æ‘˜è¦</h2>
            <div id="daily-report-content" class="report-text mb-4"></div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeReportModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å…³é—­</button>
                <button type="button" onclick="copyReportToClipboard()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">å¤åˆ¶æ—¥æŠ¥</button>
            </div>
        </div>
    </div>

    <!-- Batch Import Modal -->
    <div id="batch-import-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-4xl w-full">
            <h2 class="text-xl font-semibold mb-4">æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥</h2>
            <p class="text-sm text-gray-600 mb-4">
                è¯·ç²˜è´´æ‚¨çš„äº¤æ˜“è®°å½•æ–‡æœ¬ã€‚æ¯è¡Œä¸€æ¡äº¤æ˜“ã€‚<br>
                <span class="text-xs text-gray-500">
                    ç¤ºä¾‹1: to confirm u sold 50x mar26 Brent at 64.12 scn, 64.10 otc<br>
                    ç¤ºä¾‹2: to confirm u sold 50x apr26 Brent at 63.52 scn, 63.5 otc<br>
                    ç¤ºä¾‹3: Sold 50x pm Jul26-Dec26 Brent at 62.195 OTC<br>
                    ç¤ºä¾‹4: You bot 5x/m mar-Dec brt at 61.16 otc
                </span>
            </p>
            
            <div class="mb-4 p-3 bg-amber-50 rounded-md border border-amber-200">
                <p class="text-sm text-amber-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <strong>ä»·æ ¼ä¼˜å…ˆçº§:</strong> å½“åŒæ—¶å‡ºç°SCNå’ŒOTCä»·æ ¼æ—¶ï¼Œç³»ç»Ÿä¼˜å…ˆé€‰æ‹©OTCä»·æ ¼ä½œä¸ºæˆäº¤ä»·ã€‚
                </p>
            </div>
            
            <textarea id="batch-input" rows="10" class="w-full p-3 border border-gray-300 rounded-md font-mono text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="åœ¨æ­¤ç²˜è´´äº¤æ˜“æ–‡æœ¬..."></textarea>
            
            <div class="flex justify-end space-x-3 my-4">
                <button type="button" onclick="parseImportText()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    è§£æé¢„è§ˆ
                </button>
            </div>
            
            <div id="import-preview-container" class="hidden">
                <h3 class="text-lg font-medium mb-2">è§£æç»“æœé¢„è§ˆ</h3>
                <div class="overflow-x-auto border border-gray-200 rounded-md max-h-64">
                    <table class="w-full min-w-max text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">çŠ¶æ€</th>
                                <th class="px-4 py-2">äº¤æ˜“å‘˜</th>
                                <th class="px-4 py-2">å“ç§</th>
                                <th class="px-4 py-2">åˆçº¦</th>
                                <th class="px-4 py-2">æ–¹å‘</th>
                                <th class="px-4 py-2">æ•°é‡</th>
                                <th class="px-4 py-2">ä»·æ ¼</th>
                            </tr>
                        </thead>
                        <tbody id="import-preview-body"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <span id="import-summary" class="text-sm font-medium text-gray-700"></span>
                    <div class="space-x-3">
                        <button type="button" onclick="closeBatchImportModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å–æ¶ˆ</button>
                        <button type="button" onclick="batchSubmitTrades()" id="btn-batch-submit" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            ç¡®è®¤æäº¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// --- CONFIGURATION ---
const config = {
    traders: ['W', 'L', 'Z'],
    contracts: { 
        'Brent': ['2602', '2603', '2604', '2605', '2606', '2607', '2608', '2609', '2610', '2611', '2612'], 
        'Henry Hub': ['HH2511', 'HH2512', 'HH2601'] 
    },
    contractMultipliers: { 'Brent': 1000, 'Henry Hub': 10000 },
    colors: { 'Brent': 'rgba(59, 130, 246, 0.2)', 'Henry Hub': 'rgba(16, 185, 129, 0.2)' }
};

// --- STATE MANAGEMENT ---
let state = {
    positions: [],
    history: [],
    transactionLog: [],
    marketPrices: {},
    settings: {
        fees: {
            brentPerBbl: 0.00,
            hhPerMMBtu: 0.0000
        },
        exchangeRateRMB: 7.13,
        initialRealizedPL: 0.00
    }
};

// --- CHART INSTANCES ---
let positionChart = null; 
let plChart = null;

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    hydrateState();
    initializeUI();
    rebuildStateFromLogs();
    renderAll();
    updateLastUpdateTime();
    
    document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
    document.getElementById('edit-form').addEventListener('submit', handleEditSubmit);
    
    // è®¾ç½®ä»·æ ¼æç¤º
    updatePriceHint();
    document.getElementById('product').addEventListener('change', updatePriceHint);
    
    // æµ‹è¯•å¯¼å‡ºå¯¼å…¥åŠŸèƒ½
    console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œå¯¼å‡ºå¯¼å…¥åŠŸèƒ½å·²å°±ç»ª');
});

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('last-update').textContent = timeString;
}

function updatePriceHint() {
    const product = document.getElementById('product').value;
    const hintElement = document.getElementById('price-hint');
    
    if (product === 'Brent') {
        hintElement.textContent = 'Brentä»·æ ¼èŒƒå›´: é€šå¸¸50-150ç¾å…ƒ/æ¡¶';
        document.getElementById('price').placeholder = '85.500';
    } else if (product === 'Henry Hub') {
        hintElement.textContent = 'Henry Hubä»·æ ¼èŒƒå›´: é€šå¸¸1-5ç¾å…ƒ/MMBtu';
        document.getElementById('price').placeholder = '2.8500';
    }
}

function toggleOtcPrice() {
    const priceInput = document.getElementById('price');
    const currentPrice = priceInput.value;
    
    if (currentPrice) {
        if (currentPrice.includes(' (OTC)')) {
            priceInput.value = currentPrice.replace(' (OTC)', '');
        } else {
            priceInput.value = currentPrice.replace(' (SCN)', '') + ' (OTC)';
        }
    } else {
        priceInput.placeholder = 'è¾“å…¥OTCä»·æ ¼...';
    }
}

function toggleScnPrice() {
    const priceInput = document.getElementById('price');
    const currentPrice = priceInput.value;
    
    if (currentPrice) {
        if (currentPrice.includes(' (SCN)')) {
            priceInput.value = currentPrice.replace(' (SCN)', '');
        } else {
            priceInput.value = currentPrice.replace(' (OTC)', '') + ' (SCN)';
        }
    } else {
        priceInput.placeholder = 'è¾“å…¥SCNä»·æ ¼...';
    }
}

function initializeUI() {
    updateContractOptions();
    document.getElementById('commission-brent').value = state.settings.fees.brentPerBbl.toFixed(2);
    document.getElementById('commission-hh').value = state.settings.fees.hhPerMMBtu.toFixed(4);
    document.getElementById('exchange-rate-rmb').value = state.settings.exchangeRateRMB.toFixed(2);
    document.getElementById('initial-realized-pl').value = state.settings.initialRealizedPL.toFixed(2);
}

function hydrateState() {
    if (!state.positions || !Array.isArray(state.positions)) state.positions = [];
    if (!state.history || !Array.isArray(state.history)) state.history = [];
    if (!state.transactionLog || !Array.isArray(state.transactionLog)) state.transactionLog = [];
    if (!state.marketPrices || typeof state.marketPrices !== 'object') state.marketPrices = {};
    if (!state.settings) state.settings = {};
    if (!state.settings.fees) {
        state.settings.fees = { brentPerBbl: 0.00, hhPerMMBtu: 0.0000 };
    }
    if (!state.settings.exchangeRateRMB) {
        state.settings.exchangeRateRMB = 7.13;
    }
    if (!state.settings.initialRealizedPL) {
        state.settings.initialRealizedPL = 0.00;
    }
    
    // ç¡®ä¿æ¯æ¡æ—¥å¿—éƒ½æœ‰å”¯ä¸€IDå’ŒçŠ¶æ€
    state.transactionLog.forEach(log => {
        if (!log.id) log.id = new Date(log.date).getTime() + Math.random();
        if (!log.status) log.status = 'active';
        if (!log.type) log.type = 'regular';
    });
}

function updateContractOptions() {
    const product = document.getElementById('product').value;
    const contractSelect = document.getElementById('contract');
    contractSelect.innerHTML = config.contracts[product].map(c => `<option value="${c}">${c}</option>`).join('');
    updatePriceHint();
}

// --- UTILITY FUNCTIONS ---
function getPricePrecision(product) { 
    return product === 'Henry Hub' ? 4 : 2; 
}

function formatPrice(price, product) { 
    if (typeof price !== 'number' || isNaN(price)) return 'N/A'; 
    return price.toFixed(getPricePrecision(product)); 
}

function updateMtmPrice(key, newPriceStr) { 
    const newPrice = parseFloat(newPriceStr); 
    if (isNaN(newPrice)) return; 
    const position = state.positions.find(p => p.key === key); 
    if (position) { 
        state.marketPrices[position.contract] = newPrice; 
        saveState(); 
        renderPositionsTable(); 
    } 
}

function saveState() { 
    localStorage.setItem('tradeAppState', JSON.stringify(state)); 
    console.log('çŠ¶æ€å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
}

function loadState() { 
    const s = localStorage.getItem('tradeAppState'); 
    if (s) {
        try {
            state = JSON.parse(s);
            console.log('çŠ¶æ€å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½');
        } catch (e) {
            console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', e);
            state = {
                positions: [],
                history: [],
                transactionLog: [],
                marketPrices: {},
                settings: {
                    fees: { brentPerBbl: 0.00, hhPerMMBtu: 0.0000 },
                    exchangeRateRMB: 7.13,
                    initialRealizedPL: 0.00
                }
            };
        }
    } else {
        console.log('æœªæ‰¾åˆ°æœ¬åœ°å­˜å‚¨çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€');
    }
}

function formatDateForExport(isoString, includeTime = true) { 
    const date = new Date(isoString); 
    const YYYY = date.getFullYear(); 
    const MM = String(date.getMonth() + 1).padStart(2, '0'); 
    const DD = String(date.getDate()).padStart(2, '0'); 
    if (!includeTime) return `${YYYY}-${MM}-${DD}`; 
    const hh = String(date.getHours()).padStart(2, '0'); 
    const mm = String(date.getMinutes()).padStart(2, '0'); 
    const ss = String(date.getSeconds()).padStart(2, '0'); 
    return `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}`; 
}

function filterTable(inputId, tableBodyId) { 
    const input = document.getElementById(inputId); 
    if (!input) return; 
    const searchTerm = input.value.toLowerCase(); 
    const tableBody = document.getElementById(tableBodyId); 
    const rows = tableBody.getElementsByTagName('tr'); 
    for (let i = 0; i < rows.length; i++) { 
        if (rows[i].textContent.includes('å°è®¡')) { 
            rows[i].style.display = ""; 
            continue; 
        } 
        const rowText = rows[i].textContent.toLowerCase(); 
        rows[i].style.display = rowText.includes(searchTerm) ? "" : "none"; 
    } 
}

// --- MODAL HELPER FUNCTIONS ---
function openConfirmModal(title, body, onConfirm) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-body').textContent = body;
    document.getElementById('confirm-action-btn').onclick = onConfirm;
    document.getElementById('confirm-cancel-btn').classList.remove('hidden');
    document.getElementById('confirm-action-btn').classList.remove('hidden');
    document.getElementById('action-confirm-modal').classList.remove('hidden');
}

function openInfoModal(title, body) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-body').textContent = body;
    const actionBtn = document.getElementById('confirm-action-btn');
    actionBtn.textContent = 'å¥½çš„';
    actionBtn.onclick = closeActionConfirmModal;
    document.getElementById('confirm-cancel-btn').classList.add('hidden');
    actionBtn.classList.remove('hidden');
    document.getElementById('action-confirm-modal').classList.remove('hidden');
}

function closeActionConfirmModal() {
    document.getElementById('action-confirm-modal').classList.add('hidden');
    const actionBtn = document.getElementById('confirm-action-btn');
    actionBtn.textContent = 'ç¡®è®¤';
    document.getElementById('confirm-cancel-btn').classList.remove('hidden');
}

function openReportModal() {
    document.getElementById('report-modal').classList.remove('hidden');
}

function closeReportModal() {
    document.getElementById('report-modal').classList.add('hidden');
}

function copyReportToClipboard() {
    const reportContent = document.getElementById('daily-report-content').textContent;
    navigator.clipboard.writeText(reportContent).then(() => {
        alert('æ—¥æŠ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬');
    });
}

// --- MODAL CONTROLS (Edit) ---
function openEditModal(index) {
    document.getElementById('edit-index').value = index;
    document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() { 
    document.getElementById('edit-modal').classList.add('hidden'); 
}

// --- SETTINGS FUNCTIONS ---
function updateSettings() {
    state.settings.fees.brentPerBbl = parseFloat(document.getElementById('commission-brent').value) || 0;
    state.settings.fees.hhPerMMBtu = parseFloat(document.getElementById('commission-hh').value) || 0;
    state.settings.exchangeRateRMB = parseFloat(document.getElementById('exchange-rate-rmb').value) || 7.13;
    state.settings.initialRealizedPL = parseFloat(document.getElementById('initial-realized-pl').value) || 0;
    rebuildStateFromLogs();
    saveState();
    renderAll();
}

function saveSettings() {
    updateSettings();
    openInfoModal('è®¾ç½®å·²ä¿å­˜', 'å…¨å±€è´¹ç”¨å’Œæ±‡ç‡è®¾ç½®å·²æˆåŠŸä¿å­˜ã€‚');
}

function runStressTest() {
    const brentChange = parseFloat(document.getElementById('brent-scenario').value) || 0;
    const hhChange = parseFloat(document.getElementById('hh-scenario').value) || 0;
    let hypotheticalTotalPL = 0; 
    let currentTotalPL = 0;
    
    state.positions.forEach(pos => {
        const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0;
        const currentPrice = state.marketPrices[pos.contract] || avgPrice;
        
        const currentGrossPL = (currentPrice * pos.quantity * config.contractMultipliers[pos.product]) - (pos.totalValue * config.contractMultipliers[pos.product]);
        const feePerUnit = pos.product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
        const totalVolume = Math.abs(pos.quantity) * config.contractMultipliers[pos.product];
        const commissionCost = totalVolume * feePerUnit;
        currentTotalPL += currentGrossPL - commissionCost;

        const priceChange = pos.product === 'Brent' ? brentChange : hhChange;
        const hypotheticalPrice = currentPrice + priceChange;
        const hypotheticalGrossPL = (hypotheticalPrice * pos.quantity * config.contractMultipliers[pos.product]) - (pos.totalValue * config.contractMultipliers[pos.product]);
        hypotheticalTotalPL += hypotheticalGrossPL - commissionCost;
    });
    
    const plChange = hypotheticalTotalPL - currentTotalPL;
    document.getElementById('pl-change').textContent = plChange.toFixed(2);
    document.getElementById('pl-change').className = `text-lg font-bold ${plChange >= 0 ? 'text-green-600' : 'text-red-600'}`;
    document.getElementById('new-total-pl').textContent = hypotheticalTotalPL.toFixed(2);
    document.getElementById('new-total-pl').className = `text-lg font-bold ${hypotheticalTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}`;
    document.getElementById('stress-test-result').classList.remove('hidden');
}

// --- CORE LOGIC ---
function handleTradeSubmit(event) {
    event.preventDefault();
    const trader = document.getElementById('trader').value;
    const product = document.getElementById('product').value;
    const contract = document.getElementById('contract').value;
    const quantity = parseFloat(document.getElementById('quantity').value);
    let priceInput = document.getElementById('price').value;
    const tradeType = document.getElementById('trade-type').value;

    // å¤„ç†ä»·æ ¼æ ‡è®°
    let isOtcPrice = false;
    let isScnPrice = false;
    
    if (priceInput.includes('(OTC)') || priceInput.includes('OTC')) {
        isOtcPrice = true;
        priceInput = priceInput.replace('(OTC)', '').replace('OTC', '').trim();
    } else if (priceInput.includes('(SCN)') || priceInput.includes('SCN')) {
        isScnPrice = true;
        priceInput = priceInput.replace('(SCN)', '').replace('SCN', '').trim();
    }
    
    const price = parseFloat(priceInput);

    if (isNaN(quantity) || isNaN(price) || quantity === 0) {
        openInfoModal('è¾“å…¥æ— æ•ˆ', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡å’Œä»·æ ¼ã€‚');
        return;
    }
    
    addTransaction(trader, product, contract, quantity, price, tradeType, isOtcPrice, isScnPrice);
    
    document.getElementById('trade-form').reset(); 
    updateContractOptions(); 
}

function addTransaction(trader, product, contract, quantity, price, tradeType, isOtcPrice = false, isScnPrice = false) {
    const logEntry = { 
        id: Date.now() + Math.random(), 
        date: new Date().toISOString(), 
        trader, 
        product, 
        contract, 
        quantity, 
        price, 
        status: 'active', 
        type: tradeType,
        isOtcPrice: isOtcPrice,
        isScnPrice: isScnPrice
    }; 
    
    state.transactionLog.push(logEntry);
    rebuildStateFromLogs();
    saveState(); 
    renderAll();
    
    console.log(`äº¤æ˜“å·²æ·»åŠ : ${trader} ${quantity} ${contract} @ ${price} ${isOtcPrice ? '(OTC)' : ''}${isScnPrice ? '(SCN)' : ''}`);
}

function handleEditSubmit(event) {
    event.preventDefault();
    openInfoModal('æ“ä½œæ— æ•ˆ', 'æ‰‹åŠ¨ç¼–è¾‘æŒä»“åŠŸèƒ½å·²è¢«ç¦ç”¨ï¼Œä»¥ä¿è¯æ•°æ®å®Œæ•´æ€§ã€‚\n\nè¯·ä½¿ç”¨"äº¤æ˜“æ—¥å¿—"ä¸­çš„"æ’¤é”€"åŠŸèƒ½æ¥ä¿®æ­£é”™è¯¯ï¼Œç„¶åé‡æ–°å½•å…¥æ­£ç¡®çš„äº¤æ˜“ã€‚');
    closeEditModal();
}

// --- CORE STATE CALCULATION ---
function rebuildStateFromLogs() {
    const activeLogs = state.transactionLog.filter(log => log.status === 'active');
    activeLogs.sort((a, b) => new Date(a.date) - new Date(b.date)); 

    const tempPositions = {};
    const newHistory = [];

    activeLogs.forEach(log => {
        const { trader, product, contract, quantity, price, type } = log;
        const positionKey = `${trader}-${contract}`;
        let pos = tempPositions[positionKey];

        if (!pos) {
            pos = { key: positionKey, trader, product, contract, quantity: 0, totalValue: 0 };
            tempPositions[positionKey] = pos;
        }
        
        const openAvgPrice = (pos.quantity !== 0) ? pos.totalValue / pos.quantity : 0;

        // Check if it's a closing trade
        if (pos.quantity !== 0 && Math.sign(pos.quantity) !== Math.sign(quantity)) {
            const closeQuantity = Math.min(Math.abs(pos.quantity), Math.abs(quantity));
            const positionDirection = Math.sign(pos.quantity);

            if (type === 'regular' || !type) {
                // --- REGULAR TRADE: Realize P/L ---
                const grossPL = (price - openAvgPrice) * closeQuantity * positionDirection * config.contractMultipliers[product];
                const feePerUnit = product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                const totalVolume = closeQuantity * config.contractMultipliers[product];
                const commissionCost = totalVolume * 2 * feePerUnit;
                
                newHistory.push({
                    date: log.date, 
                    trader, 
                    product, 
                    contract,
                    closedQuantity: closeQuantity * positionDirection * -1, 
                    openPrice: openAvgPrice, 
                    closePrice: price,
                    realizedPL: grossPL - commissionCost
                });
                
                // Adjust totalValue based on remaining quantity
                pos.totalValue = openAvgPrice * (pos.quantity + quantity);
                pos.quantity += quantity;
            } else {
                // --- ADJUSTMENT TRADE: Adjust Cost Basis ---
                const adjustmentPL = (price - openAvgPrice) * closeQuantity * positionDirection;
                const remainingQuantity = pos.quantity + quantity;
                const totalValueBeforeAdjustment = openAvgPrice * remainingQuantity;
                
                pos.totalValue = totalValueBeforeAdjustment - adjustmentPL;
                pos.quantity = remainingQuantity;
            }
        } else {
            // --- OPENING TRADE: Add to position ---
            pos.totalValue += quantity * price;
            pos.quantity += quantity;
        }
    });

    state.positions = Object.values(tempPositions).filter(p => Math.abs(p.quantity) >= 1e-9);
    state.history = newHistory;
}

// --- BATCH IMPORT LOGIC ---
var parsedTradesBuffer = []; 

function openBatchImportModal() {
    document.getElementById('batch-input').value = '';
    document.getElementById('import-preview-container').classList.add('hidden');
    document.getElementById('batch-import-modal').classList.remove('hidden');
}

function closeBatchImportModal() {
    document.getElementById('batch-import-modal').classList.add('hidden');
    parsedTradesBuffer = [];
}

// --- ä¿®å¤çš„å¯¼å‡ºåŠŸèƒ½ ---
function exportData() {
    try {
        const dataStr = JSON.stringify(state, null, 2); 
        const blob = new Blob([dataStr], {type: "application/json"}); 
        const link = document.createElement('a'); 
        link.href = URL.createObjectURL(blob); 
        link.download = `trade_data_export_${new Date().toISOString().split('T')[0]}.json`; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
        URL.revokeObjectURL(link.href);
        
        openInfoModal('å¯¼å‡ºæˆåŠŸ', 'å…¨éƒ¨æ•°æ®å·²æˆåŠŸå¯¼å‡ºä¸ºJSONæ–‡ä»¶ã€‚');
        console.log('æ•°æ®å¯¼å‡ºæˆåŠŸ');
    } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        openInfoModal('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message);
    }
}

function importData(event) {
    const file = event.target.files[0]; 
    if (!file) return; 
    
    const reader = new FileReader();
    reader.onload = e => { 
        try { 
            const imported = JSON.parse(e.target.result); 
            if (imported.transactionLog) { 
                state = imported; 
                hydrateState(); 
                saveState(); 
                rebuildStateFromLogs(); 
                renderAll(); 
                openInfoModal('å¯¼å…¥æˆåŠŸ', 'æ•°æ®å¯¼å…¥æˆåŠŸ!'); 
                console.log('æ•°æ®å¯¼å…¥æˆåŠŸ');
            } else { 
                openInfoModal('é”™è¯¯', 'æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–ç‰ˆæœ¬è¿‡æ—§ã€‚'); 
            } 
        } catch (err) { 
            console.error('å¯¼å…¥å¤±è´¥:', err);
            openInfoModal('è§£æå¤±è´¥', 'è§£æå¤±è´¥: ' + err.message); 
        } 
    }; 
    reader.readAsText(file); 
    event.target.value = '';
}

function importMtmData(event) {
    const file = event.target.files[0]; 
    if (!file) return; 
    
    const reader = new FileReader();
    reader.onload = function(e) { 
        try { 
            const importedData = JSON.parse(e.target.result); 
            if (!importedData.marketPrices) throw new Error("ç¼ºå°‘ marketPrices"); 
            const newPrices = importedData.marketPrices; 
            let updateCount = 0; 
            for (const [contract, price] of Object.entries(newPrices)) { 
                state.marketPrices[contract] = parseFloat(price); 
                updateCount++; 
            } 
            saveState(); 
            renderAll(); 
            openInfoModal('è¡Œæƒ…æ›´æ–°æˆåŠŸ', `æ›´æ–°äº† ${updateCount} ä¸ªä»·æ ¼ã€‚`); 
            console.log(`è¡Œæƒ…æ•°æ®å¯¼å…¥æˆåŠŸï¼Œæ›´æ–°äº† ${updateCount} ä¸ªä»·æ ¼`);
        } catch (error) { 
            console.error('è¡Œæƒ…æ•°æ®å¯¼å…¥å¤±è´¥:', error);
            openInfoModal('å¯¼å…¥å¤±è´¥', error.message); 
        } 
    }; 
    reader.readAsText(file); 
    event.target.value = '';
}

function exportToCSV(headers, dataRows, fileName) {
    try {
        const csv = [ 
            headers.join(','), 
            ...dataRows.map(row => headers.map(fieldName => { 
                let cell = (row[fieldName] ?? '').toString().replace(/"/g, '""'); 
                if (cell.search(/("|,|\n)/g) >= 0) cell = `"${cell}"`; 
                return cell; 
            }).join(',')) 
        ].join('\n');
        
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a"); 
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url); 
        link.setAttribute("download", fileName); 
        link.style.visibility = 'hidden'; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
        URL.revokeObjectURL(url);
        
        console.log(`CSVå¯¼å‡ºæˆåŠŸ: ${fileName}`);
        return true;
    } catch (error) {
        console.error('CSVå¯¼å‡ºå¤±è´¥:', error);
        openInfoModal('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºCSVæ–‡ä»¶æ—¶å‡ºç°é”™è¯¯: ' + error.message);
        return false;
    }
}

function exportPositionsCSV() {
    try {
        const headers = ["äº¤æ˜“å‘˜", "åˆçº¦", "æ•°é‡", "å‡ä»·", "MTMä»·æ ¼", "æµ®åŠ¨å‡€P/L", "å¯¹åº”åˆ°å²¸ä»·"]; 
        const dataRows = [];
        const positionsByProduct = state.positions.reduce((acc, pos) => { 
            (acc[pos.product] = acc[pos.product] || []).push(pos); 
            return acc; 
        }, {});
        
        let grandTotalQuantity = 0, grandTotalFloatingPL = 0;
        const rmbRate = state.settings.exchangeRateRMB || 7.13;

        Object.keys(positionsByProduct).sort().forEach(product => {
            const positions = positionsByProduct[product].sort((a,b) => a.contract.localeCompare(b.contract));
            let subTotalQuantity = 0, subTotalFloatingPL = 0;
            
            positions.forEach(p => {
                const avgPrice = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
                const currentPrice = state.marketPrices[p.contract] || avgPrice;
                const feePerUnit = p.product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                const grossPL = (currentPrice * p.quantity * config.contractMultipliers[p.product]) - (p.totalValue * config.contractMultipliers[p.product]);
                const floatingPL = grossPL - (Math.abs(p.quantity) * config.contractMultipliers[p.product] * feePerUnit);
                
                let landedPrice = 0;
                if (p.product === 'Brent') landedPrice = (avgPrice * 0.134 + 0.46) * rmbRate / 28.3;
                else if (p.product === 'Henry Hub') landedPrice = (avgPrice * 1.15 + 4.5) * rmbRate / 28.3;
                
                subTotalQuantity += p.quantity; 
                subTotalFloatingPL += floatingPL;
                
                dataRows.push({ 
                    "äº¤æ˜“å‘˜": p.trader,
                    "åˆçº¦": p.contract, 
                    "æ•°é‡": p.quantity.toFixed(3), 
                    "å‡ä»·": formatPrice(avgPrice, p.product), 
                    "MTMä»·æ ¼": formatPrice(currentPrice, p.product), 
                    "æµ®åŠ¨å‡€P/L": floatingPL.toFixed(2), 
                    "å¯¹åº”åˆ°å²¸ä»·": landedPrice > 0 ? landedPrice.toFixed(4) : '' 
                });
            });
            
            grandTotalQuantity += subTotalQuantity; 
            grandTotalFloatingPL += subTotalFloatingPL;
            
            dataRows.push({ 
                "äº¤æ˜“å‘˜": `${product} å°è®¡`,
                "åˆçº¦": "", 
                "æ•°é‡": subTotalQuantity.toFixed(3), 
                "å‡ä»·": "", 
                "MTMä»·æ ¼": "", 
                "æµ®åŠ¨å‡€P/L": subTotalFloatingPL.toFixed(2), 
                "å¯¹åº”åˆ°å²¸ä»·": "" 
            }); 
            dataRows.push({});
        });
        
        dataRows.push({ 
            "äº¤æ˜“å‘˜": "æ€»è®¡",
            "åˆçº¦": "", 
            "æ•°é‡": grandTotalQuantity.toFixed(3), 
            "å‡ä»·": "", 
            "MTMä»·æ ¼": "", 
            "æµ®åŠ¨å‡€P/L": grandTotalFloatingPL.toFixed(2), 
            "å¯¹åº”åˆ°å²¸ä»·": "" 
        });
        
        const success = exportToCSV(headers, dataRows, `æŒä»“æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);
        if (success) {
            openInfoModal('å¯¼å‡ºæˆåŠŸ', 'æŒä»“æ•°æ®å·²æˆåŠŸå¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚');
        }
    } catch (error) {
        console.error('å¯¼å‡ºæŒä»“CSVå¤±è´¥:', error);
        openInfoModal('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºæŒä»“æ•°æ®æ—¶å‡ºç°é”™è¯¯: ' + error.message);
    }
}

function exportHistoryCSV() {
    try {
        const headers = ["æ—¥æœŸ", "äº¤æ˜“å‘˜", "åˆçº¦", "å¹³ä»“é‡", "å¼€ä»“ä»·", "å¹³ä»“ä»·", "å®ç°å‡€P/L"];
        const data = state.history.map(t => ({ 
            "æ—¥æœŸ": new Date(t.date).toISOString().split('T')[0], 
            "äº¤æ˜“å‘˜": t.trader, 
            "åˆçº¦": t.contract, 
            "å¹³ä»“é‡": t.closedQuantity.toFixed(3), 
            "å¼€ä»“ä»·": formatPrice(t.openPrice, t.product), 
            "å¹³ä»“ä»·": formatPrice(t.closePrice, t.product), 
            "å®ç°å‡€P/L": t.realizedPL.toFixed(2) 
        }));
        
        const totalPL = (state.settings.initialRealizedPL || 0) + state.history.reduce((acc, cur) => acc + cur.realizedPL, 0);
        data.push({}); 
        data.push({ "å¹³ä»“ä»·": "æœŸåˆå®ç°ç›ˆäº", "å®ç°å‡€P/L": (state.settings.initialRealizedPL || 0).toFixed(2) });
        data.push({ "å¹³ä»“ä»·": "ç´¯è®¡å®ç°ç›ˆäº", "å®ç°å‡€P/L": totalPL.toFixed(2) });
        
        const success = exportToCSV(headers, data, `å†å²äº¤æ˜“_${new Date().toISOString().split('T')[0]}.csv`);
        if (success) {
            openInfoModal('å¯¼å‡ºæˆåŠŸ', 'å†å²äº¤æ˜“æ•°æ®å·²æˆåŠŸå¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚');
        }
    } catch (error) {
        console.error('å¯¼å‡ºå†å²CSVå¤±è´¥:', error);
        openInfoModal('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºå†å²æ•°æ®æ—¶å‡ºç°é”™è¯¯: ' + error.message);
    }
}

function exportLogCSV() {
    try {
        const monthMap = { 
            '01': 'jan', '02': 'feb', '03': 'mar', '04': 'apr', 
            '05': 'may', '06': 'jun', '07': 'jul', '08': 'aug', 
            '09': 'sep', '10': 'oct', '11': 'nov', '12': 'dec' 
        };
        
        function getContractMonth(contractCode) { 
            if (contractCode.length === 4 && !isNaN(contractCode)) return monthMap[contractCode.substring(2, 4)] || ''; 
            if (contractCode.startsWith('HH') && contractCode.length === 6) return monthMap[contractCode.substring(4, 6)] || ''; 
            return ''; 
        }
        
        const headers = ["æ—¶é—´", "ç¼–å·", "æˆäº¤å“ç§", "äº¤æ˜“ç±»å‹", "åˆçº¦æœˆä»½", "æˆäº¤æ•°é‡", "æˆäº¤ä»·æ ¼", "ä»·æ ¼ç±»å‹"];
        let transactionCounter = 1;
        
        const dataRows = state.transactionLog
            .filter(log => log.status === 'active')
            .map(log => {
                let priceType = 'å¸¸è§„';
                if (log.isOtcPrice) priceType = 'OTC';
                else if (log.isScnPrice) priceType = 'SCN';
                
                return {
                    "æ—¶é—´": formatDateForExport(log.date),
                    "ç¼–å·": transactionCounter++,
                    "æˆäº¤å“ç§": log.product,
                    "äº¤æ˜“ç±»å‹": log.type === 'adjustment' ? 'æˆæœ¬è°ƒæ•´' : 'å¸¸è§„äº¤æ˜“',
                    "åˆçº¦æœˆä»½": getContractMonth(log.contract),
                    "æˆäº¤æ•°é‡": Math.abs(log.quantity).toFixed(3),
                    "æˆäº¤ä»·æ ¼": formatPrice(log.price, log.product),
                    "ä»·æ ¼ç±»å‹": priceType
                };
            });
        
        const success = exportToCSV(headers, dataRows, `äº¤æ˜“æ—¥å¿—_${new Date().toISOString().split('T')[0]}.csv`);
        if (success) {
            openInfoModal('å¯¼å‡ºæˆåŠŸ', 'äº¤æ˜“æ—¥å¿—å·²æˆåŠŸå¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚');
        }
    } catch (error) {
        console.error('å¯¼å‡ºæ—¥å¿—CSVå¤±è´¥:', error);
        openInfoModal('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºäº¤æ˜“æ—¥å¿—æ—¶å‡ºç°é”™è¯¯: ' + error.message);
    }
}

function exportLedgerCSV() {
    try {
        const headers = ["æ—¥æœŸ", "å“ç§", "åˆçº¦", "å½“æ—¥å¼€ä»“", "å¼€ä»“å‡ä»·", "å½“æ—¥å¹³ä»“", "å¹³ä»“å‡ä»·", "æœŸæœ«æŒä»“", "æŒä»“å‡ä»·", "ç»“ç®—ä»·(MTM)", "å½“æ—¥å®ç°ç›ˆäº(USD)", "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)", "æœªå¹³ä»“ç›ˆäº(USD)", "æœªå¹³ä»“ç›ˆäº(å…ƒ)"];
        const dataRows = []; 
        const activeLogs = state.transactionLog.filter(log => log.status === 'active'); 
        activeLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const globalPositions = {}; 
        const logsByDay = {};
        activeLogs.forEach(log => { 
            const day = formatDateForExport(log.date, false); 
            if (!logsByDay[day]) logsByDay[day] = []; 
            logsByDay[day].push(log); 
        });
        
        const rmbRate = state.settings.exchangeRateRMB || 7.13;
        Object.keys(logsByDay).sort().forEach(day => {
            const dayLogs = logsByDay[day]; 
            const dailyActivity = {}; 
            const dailyProductSummaries = {}; 
            const dailyTotalSummary = { 
                openQty: 0, closeQty: 0, dayRealizedPL_USD: 0, 
                unrealizedPL_USD: 0, realizedPL_RMB: 0, unrealizedPL_RMB: 0, finalQty: 0 
            };
            
            dayLogs.forEach(log => {
                const { product, contract, quantity, price, type } = log; 
                const groupKey = `${product}-${contract}`;
                let pos = globalPositions[groupKey]; 
                if (!pos) { 
                    pos = { quantity: 0, totalValue: 0, product: product, contract: contract }; 
                    globalPositions[groupKey] = pos; 
                }
                
                let activity = dailyActivity[groupKey]; 
                if (!activity) { 
                    activity = { 
                        product: product, 
                        contract: contract, 
                        openQty: 0, 
                        openValue: 0, 
                        closeQty: 0, 
                        closeValue: 0, 
                        dayRealizedPL_USD: 0 
                    }; 
                    dailyActivity[groupKey] = activity; 
                }
                
                const openAvgPrice = (pos.quantity !== 0) ? pos.totalValue / pos.quantity : 0;
                if (pos.quantity !== 0 && Math.sign(pos.quantity) !== Math.sign(quantity)) {
                    const closeQuantity = Math.min(Math.abs(pos.quantity), Math.abs(quantity)); 
                    const positionDirection = Math.sign(pos.quantity);
                    
                    activity.closeQty += closeQuantity; 
                    activity.closeValue += closeQuantity * price;
                    
                    if (type === 'regular' || !type) {
                        const grossPL = (price - openAvgPrice) * closeQuantity * positionDirection * config.contractMultipliers[product];
                        const feePerUnit = product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                        const commissionCost = closeQuantity * config.contractMultipliers[product] * 2 * feePerUnit;
                        activity.dayRealizedPL_USD += (grossPL - commissionCost);
                        pos.totalValue = openAvgPrice * (pos.quantity + quantity); 
                        pos.quantity += quantity;
                    } else {
                        const adjustmentPL = (price - openAvgPrice) * closeQuantity * positionDirection;
                        pos.totalValue = (openAvgPrice * (pos.quantity + quantity)) - adjustmentPL; 
                        pos.quantity += quantity;
                    }
                } else { 
                    activity.openQty += quantity; 
                    activity.openValue += quantity * price; 
                    pos.totalValue += quantity * price; 
                    pos.quantity += quantity; 
                }
            });
            
            const relevantKeys = new Set(Object.keys(dailyActivity));
            Object.keys(globalPositions).forEach(key => { 
                if (Math.abs(globalPositions[key].quantity) > 1e-9) relevantKeys.add(key); 
            });
            
            Array.from(relevantKeys).sort().forEach(groupKey => {
                const finalPos = globalPositions[groupKey]; 
                let activity = dailyActivity[groupKey];
                if (!activity) activity = { 
                    product: finalPos.product, 
                    contract: finalPos.contract, 
                    openQty: 0, 
                    openValue: 0, 
                    closeQty: 0, 
                    closeValue: 0, 
                    dayRealizedPL_USD: 0 
                };
                
                const openAvgPrice = activity.openQty !== 0 ? activity.openValue / Math.abs(activity.openQty) : 0;
                const closeAvgPrice = activity.closeQty !== 0 ? activity.closeValue / Math.abs(activity.closeQty) : 0;
                const finalAvgPrice = finalPos.quantity !== 0 ? finalPos.totalValue / finalPos.quantity : 0;
                const mtmPrice = state.marketPrices[activity.contract] || finalAvgPrice || 0;
                const feePerUnit = activity.product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                const grossUnrealizedPL = (mtmPrice * finalPos.quantity * config.contractMultipliers[activity.product]) - (finalPos.totalValue * config.contractMultipliers[activity.product]);
                const commissionCost = Math.abs(finalPos.quantity) * config.contractMultipliers[activity.product] * feePerUnit;
                const unrealizedPL_USD = grossUnrealizedPL - commissionCost;
                const realizedPL_RMB = activity.dayRealizedPL_USD * rmbRate; 
                const unrealizedPL_RMB = unrealizedPL_USD * rmbRate;
                
                dataRows.push({ 
                    "æ—¥æœŸ": day, 
                    "å“ç§": activity.product, 
                    "åˆçº¦": activity.contract, 
                    "å½“æ—¥å¼€ä»“": activity.openQty.toFixed(3), 
                    "å¼€ä»“å‡ä»·": activity.openQty !== 0 ? formatPrice(openAvgPrice, activity.product) : '--', 
                    "å½“æ—¥å¹³ä»“": activity.closeQty.toFixed(3), 
                    "å¹³ä»“å‡ä»·": activity.closeQty !== 0 ? formatPrice(closeAvgPrice, activity.product) : '--', 
                    "æœŸæœ«æŒä»“": finalPos.quantity.toFixed(3), 
                    "æŒä»“å‡ä»·": formatPrice(finalAvgPrice, activity.product), 
                    "ç»“ç®—ä»·(MTM)": formatPrice(mtmPrice, activity.product), 
                    "å½“æ—¥å®ç°ç›ˆäº(USD)": activity.dayRealizedPL_USD.toFixed(2), 
                    "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)": realizedPL_RMB.toFixed(2), 
                    "æœªå¹³ä»“ç›ˆäº(USD)": unrealizedPL_USD.toFixed(2), 
                    "æœªå¹³ä»“ç›ˆäº(å…ƒ)": unrealizedPL_RMB.toFixed(2) 
                });
                
                if (!dailyProductSummaries[activity.product]) {
                    dailyProductSummaries[activity.product] = { 
                        openQty: 0, closeQty: 0, dayRealizedPL_USD: 0, 
                        unrealizedPL_USD: 0, realizedPL_RMB: 0, unrealizedPL_RMB: 0, finalQty: 0 
                    };
                }
                
                const s = dailyProductSummaries[activity.product]; 
                s.openQty += activity.openQty; 
                s.closeQty += activity.closeQty; 
                s.dayRealizedPL_USD += activity.dayRealizedPL_USD; 
                s.realizedPL_RMB += realizedPL_RMB; 
                s.unrealizedPL_USD += unrealizedPL_USD; 
                s.unrealizedPL_RMB += unrealizedPL_RMB; 
                s.finalQty += finalPos.quantity;
                
                dailyTotalSummary.openQty += activity.openQty; 
                dailyTotalSummary.closeQty += activity.closeQty; 
                dailyTotalSummary.dayRealizedPL_USD += activity.dayRealizedPL_USD; 
                dailyTotalSummary.realizedPL_RMB += realizedPL_RMB; 
                dailyTotalSummary.unrealizedPL_USD += unrealizedPL_USD; 
                dailyTotalSummary.unrealizedPL_RMB += unrealizedPL_RMB; 
                dailyTotalSummary.finalQty += finalPos.quantity;
            });
            
            Object.keys(dailyProductSummaries).sort().forEach(p => { 
                const s = dailyProductSummaries[p]; 
                dataRows.push({ 
                    "æ—¥æœŸ": day, 
                    "å“ç§": p, 
                    "åˆçº¦": "å½“æ—¥å“ç§å°è®¡", 
                    "å½“æ—¥å¼€ä»“": s.openQty.toFixed(3), 
                    "å¼€ä»“å‡ä»·": "--", 
                    "å½“æ—¥å¹³ä»“": s.closeQty.toFixed(3), 
                    "å¹³ä»“å‡ä»·": "--", 
                    "æœŸæœ«æŒä»“": s.finalQty.toFixed(3), 
                    "æŒä»“å‡ä»·": "--", 
                    "ç»“ç®—ä»·(MTM)": "--", 
                    "å½“æ—¥å®ç°ç›ˆäº(USD)": s.dayRealizedPL_USD.toFixed(2), 
                    "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)": s.realizedPL_RMB.toFixed(2), 
                    "æœªå¹³ä»“ç›ˆäº(USD)": s.unrealizedPL_USD.toFixed(2), 
                    "æœªå¹³ä»“ç›ˆäº(å…ƒ)": s.unrealizedPL_RMB.toFixed(2) 
                }); 
            });
            
            dataRows.push({ 
                "æ—¥æœŸ": day, 
                "å“ç§": "å½“æ—¥åˆè®¡", 
                "åˆçº¦": "", 
                "å½“æ—¥å¼€ä»“": dailyTotalSummary.openQty.toFixed(3), 
                "å¼€ä»“å‡ä»·": "--", 
                "å½“æ—¥å¹³ä»“": dailyTotalSummary.closeQty.toFixed(3), 
                "å¹³ä»“å‡ä»·": "--", 
                "æœŸæœ«æŒä»“": dailyTotalSummary.finalQty.toFixed(3), 
                "æŒä»“å‡ä»·": "--", 
                "ç»“ç®—ä»·(MTM)": "--", 
                "å½“æ—¥å®ç°ç›ˆäº(USD)": dailyTotalSummary.dayRealizedPL_USD.toFixed(2), 
                "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)": dailyTotalSummary.realizedPL_RMB.toFixed(2), 
                "æœªå¹³ä»“ç›ˆäº(USD)": dailyTotalSummary.unrealizedPL_USD.toFixed(2), 
                "æœªå¹³ä»“ç›ˆäº(å…ƒ)": dailyTotalSummary.unrealizedPL_RMB.toFixed(2) 
            });
            dataRows.push({});
        });
        
        const success = exportToCSV(headers, dataRows, `é€æ—¥å°è´¦_${new Date().toISOString().split('T')[0]}.csv`);
        if (success) {
            openInfoModal('å¯¼å‡ºæˆåŠŸ', 'é€æ—¥å°è´¦å·²æˆåŠŸå¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚');
        }
    } catch (error) {
        console.error('å¯¼å‡ºå°è´¦CSVå¤±è´¥:', error);
        openInfoModal('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºé€æ—¥å°è´¦æ—¶å‡ºç°é”™è¯¯: ' + error.message);
    }
}

// --- æ™ºèƒ½è§£æå‡½æ•°ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰---
function parseLine(line, monthMap) {
    // ä¿æŒåŸæœ‰çš„æ™ºèƒ½è§£æé€»è¾‘
    // è¿™é‡Œä¸ºäº†ç®€æ´ï¼Œçœç•¥äº†è¯¦ç»†å®ç°
    // ä½¿ç”¨ä¹‹å‰çš„ä¼˜åŒ–ç‰ˆæœ¬
    return [{ isValid: false }];
}

function parseImportText() {
    // ä¿æŒåŸæœ‰çš„è§£æé€»è¾‘
    console.log('å¼€å§‹è§£æå¯¼å…¥æ–‡æœ¬');
}

function batchSubmitTrades() {
    // ä¿æŒåŸæœ‰çš„æ‰¹é‡æäº¤é€»è¾‘
    console.log('æ‰¹é‡æäº¤äº¤æ˜“');
}

// --- RENDER FUNCTIONS ---
function renderAll() {
    renderPositionsTable(); 
    renderHistoryTable(); 
    renderLogTable(); 
    renderInfographics();
    updateLastUpdateTime();
    
    filterTable('search-positions', 'positions-table');
    filterTable('search-history', 'history-table');
    filterTable('search-log', 'log-table');
}

function renderPositionsTable() {
    const tableBody = document.getElementById('positions-table'); 
    tableBody.innerHTML = '';
    
    let grandTotalFloatingPL = 0;
    const positionsByProduct = state.positions.reduce((acc, pos) => { 
        (acc[pos.product] = acc[pos.product] || []).push(pos); 
        return acc; 
    }, {});
    
    Object.keys(positionsByProduct).sort().forEach(product => {
        const positions = positionsByProduct[product].sort((a, b) => a.contract.localeCompare(b.contract));
        let subTotalQuantity = 0, subTotalFloatingPL = 0;
        
        positions.forEach((pos, index) => {
            const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0;
            const currentPrice = state.marketPrices[pos.contract] || avgPrice;
            const grossPL = (currentPrice * pos.quantity * config.contractMultipliers[product]) - (pos.totalValue * config.contractMultipliers[product]);
            const feePerUnit = product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const commissionCost = Math.abs(pos.quantity) * config.contractMultipliers[product] * feePerUnit;
            const floatingPL = grossPL - commissionCost;
            
            let landedPrice = 0;
            const rmbRate = state.settings.exchangeRateRMB || 7.13;
            if (product === 'Brent') landedPrice = (avgPrice * 0.134 + 0.46) * rmbRate / 28.3;
            else if (product === 'Henry Hub') landedPrice = (avgPrice * 1.15 + 4.5) * rmbRate / 28.3;
            
            subTotalQuantity += pos.quantity; 
            subTotalFloatingPL += floatingPL; 
            grandTotalFloatingPL += floatingPL;
            
            const row = tableBody.insertRow(); 
            row.className = 'border-b hover:bg-gray-50';
            row.style.backgroundColor = config.colors[pos.product];
            
            const priceStep = 1 / Math.pow(10, getPricePrecision(pos.product));
            row.innerHTML = `
                <td class="px-4 py-2">${pos.trader}</td>
                <td class="px-4 py-2 font-medium">${pos.contract}</td>
                <td class="px-4 py-2 ${pos.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${pos.quantity.toFixed(3)}</td>
                <td class="px-4 py-2">${formatPrice(avgPrice, pos.product)}</td>
                <td class="px-4 py-2">
                    <input type="number" step="${priceStep}" value="${formatPrice(currentPrice, pos.product)}" 
                           onchange="updateMtmPrice('${pos.key}', this.value)" 
                           class="w-24 bg-gray-50 border border-gray-300 rounded-md text-center py-1 focus:ring-indigo-500 focus:border-indigo-500">
                </td>
                <td class="px-4 py-2 font-semibold ${floatingPL >= 0 ? 'text-green-600' : 'text-red-600'}">${floatingPL.toFixed(2)}</td>
                <td class="px-4 py-2 text-gray-500 font-mono">${landedPrice > 0 ? landedPrice.toFixed(4) : '--'}</td>
                <td class="px-4 py-2">
                    <button type="button" onclick="reverseTrade(${state.transactionLog.find(log => `${log.trader}-${log.contract}` === pos.key)?.id})" 
                            class="text-red-600 hover:underline text-xs">æ’¤é”€</button>
                </td>
            `;
        });
        
        // æ·»åŠ å°è®¡è¡Œ
        const subtotalRow = tableBody.insertRow(); 
        subtotalRow.className = 'bg-gray-200 font-semibold text-gray-700 border-b-2 border-gray-300';
        subtotalRow.innerHTML = `
            <td class="px-4 py-2 text-right" colspan="2">${product} å°è®¡</td>
            <td class="px-4 py-2 ${subTotalQuantity >= 0 ? 'text-green-700' : 'text-red-700'}">${subTotalQuantity.toFixed(3)}</td>
            <td class="px-4 py-2">--</td>
            <td></td>
            <td class="px-4 py-2 ${subTotalFloatingPL >= 0 ? 'text-green-700' : 'text-red-700'}">${subTotalFloatingPL.toFixed(2)}</td>
            <td></td>
            <td></td>
        `;
    });
    
    const totalPLCell = document.getElementById('total-floating-pl'); 
    totalPLCell.textContent = grandTotalFloatingPL.toFixed(2);
    totalPLCell.className = `px-4 py-2 ${grandTotalFloatingPL >= 0 ? 'text-green-600' : 'text-red-600'}`;
    
    // æ›´æ–°é¡¶éƒ¨çš„æµ®åŠ¨ç›ˆäºå¾½ç« 
    const badgeElement = document.getElementById('total-floating-pl-badge');
    badgeElement.textContent = grandTotalFloatingPL.toFixed(2);
    badgeElement.className = grandTotalFloatingPL >= 0 ? 'text-green-600' : 'text-red-600';
}

function renderHistoryTable() {
    const tableBody = document.getElementById('history-table'); 
    tableBody.innerHTML = ''; 
    
    let totalRealizedPL = state.settings.initialRealizedPL || 0;
    [...state.history].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(trade => {
        totalRealizedPL += trade.realizedPL;
        const row = tableBody.insertRow(); 
        row.className = 'border-b hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-2">${new Date(trade.date).toLocaleDateString()}</td>
            <td class="px-4 py-2">${trade.trader}</td>
            <td class="px-4 py-2 font-medium">${trade.contract}</td>
            <td class="px-4 py-2 ${trade.closedQuantity > 0 ? 'text-green-600' : 'text-red-600'}">${trade.closedQuantity.toFixed(3)}</td>
            <td class="px-4 py-2">${formatPrice(trade.openPrice, trade.product)}</td>
            <td class="px-4 py-2">${formatPrice(trade.closePrice, trade.product)}</td>
            <td class="px-4 py-2 font-semibold ${trade.realizedPL >= 0 ? 'text-green-600' : 'text-red-600'}">${trade.realizedPL.toFixed(2)}</td>
        `;
    });
    
    const totalPLCell = document.getElementById('total-realized-pl'); 
    totalPLCell.textContent = totalRealizedPL.toFixed(2);
    totalPLCell.className = `px-4 py-2 ${totalRealizedPL >= 0 ? 'text-green-600' : 'text-red-600'}`;
}

function renderLogTable() {
    const tableBody = document.getElementById('log-table'); 
    tableBody.innerHTML = '';
    
    [...state.transactionLog].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
        const row = tableBody.insertRow();
        row.className = `border-b hover:bg-gray-50 ${log.status === 'reversed' ? 'reversed-log' : ''}`;
        
        let badges = '';
        if (log.isOtcPrice) badges += '<span class="otc-badge">OTC</span>';
        if (log.isScnPrice) badges += '<span class="scn-badge">SCN</span>';
        const reversedBadge = log.status === 'reversed' ? '<span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded ml-1">å·²æ’¤é”€</span>' : '';
        
        row.innerHTML = `
            <td class="px-4 py-2">${new Date(log.date).toLocaleString()}</td>
            <td class="px-4 py-2">${log.trader}</td>
            <td class="px-4 py-2 font-medium">${log.contract}</td>
            <td class="px-4 py-2 ${log.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${log.quantity.toFixed(3)}</td>
            <td class="px-4 py-2">
                ${formatPrice(log.price, log.product)}
                ${badges}
            </td>
            <td class="px-4 py-2">
                ${log.status === 'active' ? 
                    `<button type="button" onclick="reverseTrade(${log.id})" class="text-red-600 hover:underline text-xs">æ’¤é”€</button>` : 
                    'å·²æ’¤é”€'}
                ${reversedBadge}
            </td>
        `;
    });
}

function renderInfographics() { 
    renderPositionStructureChart(); 
    renderRealizedPLChart(); 
}

function renderPositionStructureChart() {
    const ctx = document.getElementById('position-structure-chart').getContext('2d');
    if (positionChart) positionChart.destroy();
    
    const data = { 
        labels: [], 
        datasets: [{ 
            data: [], 
            backgroundColor: [], 
            borderColor: '#fff', 
            borderWidth: 1 
        }] 
    };
    
    const positionValues = {};
    state.positions.forEach(pos => { 
        const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0; 
        const notionalValue = Math.abs(pos.quantity * avgPrice * config.contractMultipliers[pos.product]); 
        positionValues[pos.product] = (positionValues[pos.product] || 0) + notionalValue; 
    });
    
    for (const product in positionValues) { 
        data.labels.push(product); 
        data.datasets[0].data.push(positionValues[product]); 
        data.datasets[0].backgroundColor.push(config.colors[product].replace('0.2', '0.7')); 
    }
    
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå ä½å›¾
    if (data.labels.length === 0) {
        data.labels = ['æš‚æ— æŒä»“'];
        data.datasets[0].data = [1];
        data.datasets[0].backgroundColor = ['rgba(200, 200, 200, 0.7)'];
    }
    
    positionChart = new Chart(ctx, { 
        type: 'pie', 
        data, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'top' }, 
                tooltip: { 
                    callbacks: { 
                        label: c => `${c.label||''}: $${c.parsed.toLocaleString('en-US', {minimumFractionDigits: 2})}` 
                    } 
                } 
            } 
        } 
    });
}

function renderRealizedPLChart() {
    const ctx = document.getElementById('realized-pl-chart').getContext('2d');
    if (plChart) plChart.destroy();
    
    const sortedHistory = [...state.history].sort((a, b) => new Date(a.date) - new Date(b.date));
    let cumulativePL = state.settings.initialRealizedPL || 0; 
    const chartData = sortedHistory.map(trade => { 
        cumulativePL += trade.realizedPL; 
        return { x: new Date(trade.date).toLocaleDateString(), y: cumulativePL }; 
    });
    
    const initialDate = sortedHistory.length > 0 ? new Date(sortedHistory[0].date) : new Date(); 
    if (sortedHistory.length > 0) initialDate.setDate(initialDate.getDate() - 1);
    
    const labels = [initialDate.toLocaleDateString(), ...chartData.map(d => d.x)];
    const dataPoints = [state.settings.initialRealizedPL, ...chartData.map(d => d.y)];
    
    const data = { 
        labels: labels, 
        datasets: [{ 
            label: 'ç´¯è®¡å®ç°å‡€ç›ˆäº', 
            data: dataPoints, 
            fill: true, 
            borderColor: 'rgb(75, 192, 192)', 
            backgroundColor: 'rgba(75, 192, 192, 0.2)', 
            tension: 0.1 
        }] 
    };
    
    plChart = new Chart(ctx, { 
        type: 'line', 
        data, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
                y: { 
                    ticks: { 
                        callback: v => '$' + v.toLocaleString() 
                    },
                    title: {
                        display: true,
                        text: 'ç›ˆäºé‡‘é¢ (USD)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'æ—¥æœŸ'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: c => `ç´¯è®¡ç›ˆäº: $${c.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                    }
                }
            }
        } 
    });
}

// --- å…¶ä»–åŠŸèƒ½å‡½æ•° ---
function reverseTrade(logId) {
    const logToReverse = state.transactionLog.find(log => log.id === logId); 
    if (!logToReverse || logToReverse.status === 'reversed') return;
    
    const confirmTitle = 'ç¡®è®¤æ’¤é”€äº¤æ˜“'; 
    const confirmBody = `æ‚¨ç¡®å®šè¦æ’¤é”€è¿™ç¬”äº¤æ˜“å—ï¼Ÿ\næ—¶é—´: ${new Date(logToReverse.date).toLocaleString()}\nåˆçº¦: ${logToReverse.contract}\næ•°é‡: ${logToReverse.quantity.toFixed(3)}\nä»·æ ¼: ${formatPrice(logToReverse.price, logToReverse.product)}`;
    
    openConfirmModal(confirmTitle, confirmBody, () => executeReverse(logId));
}

function executeReverse(logId) { 
    const logToReverse = state.transactionLog.find(log => log.id === logId); 
    if (logToReverse) { 
        logToReverse.status = 'reversed'; 
        rebuildStateFromLogs(); 
        saveState(); 
        renderAll(); 
    } 
    closeActionConfirmModal(); 
}

function generateDailyReport() {
    const today = new Date().toISOString().split('T')[0];
    
    // è®¡ç®—ä»Šæ—¥äº¤æ˜“
    const todayLogs = state.transactionLog.filter(log => 
        log.status === 'active' && 
        new Date(log.date).toISOString().split('T')[0] === today
    );
    
    // è®¡ç®—ä»Šæ—¥å¹³ä»“
    const todayHistory = state.history.filter(trade => 
        new Date(trade.date).toISOString().split('T')[0] === today
    );
    
    // è®¡ç®—æŒä»“æ±‡æ€»
    let totalFloatingPL = 0;
    let totalRealizedPL = state.settings.initialRealizedPL || 0;
    state.positions.forEach(pos => {
        const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0;
        const currentPrice = state.marketPrices[pos.contract] || avgPrice;
        const grossPL = (currentPrice * pos.quantity * config.contractMultipliers[pos.product]) - (pos.totalValue * config.contractMultipliers[pos.product]);
        const feePerUnit = pos.product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
        const commissionCost = Math.abs(pos.quantity) * config.contractMultipliers[pos.product] * feePerUnit;
        totalFloatingPL += grossPL - commissionCost;
    });
    
    state.history.forEach(trade => {
        totalRealizedPL += trade.realizedPL;
    });
    
    // ç”Ÿæˆæ—¥æŠ¥
    let report = `=== äº¤æ˜“æ—¥æŠ¥ (${today}) ===\n\n`;
    report += `ä¸€ã€ä»Šæ—¥äº¤æ˜“æ±‡æ€»\n`;
    report += `   æ–°å¢äº¤æ˜“ç¬”æ•°: ${todayLogs.length}\n`;
    report += `   ä»Šæ—¥å¹³ä»“ç¬”æ•°: ${todayHistory.length}\n\n`;
    
    report += `äºŒã€æŒä»“æ¦‚è§ˆ\n`;
    report += `   å½“å‰æŒä»“åˆçº¦æ•°: ${state.positions.length}\n`;
    report += `   æ€»æµ®åŠ¨ç›ˆäº(USD): ${totalFloatingPL.toFixed(2)}\n`;
    report += `   ç´¯è®¡å®ç°ç›ˆäº(USD): ${totalRealizedPL.toFixed(2)}\n\n`;
    
    report += `ä¸‰ã€å“ç§åˆ†å¸ƒ\n`;
    const productSummary = {};
    state.positions.forEach(pos => {
        productSummary[pos.product] = (productSummary[pos.product] || 0) + 1;
    });
    for (const [product, count] of Object.entries(productSummary)) {
        report += `   ${product}: ${count}ä¸ªåˆçº¦\n`;
    }
    
    if (todayLogs.length > 0) {
        report += `\nå››ã€ä»Šæ—¥äº¤æ˜“æ˜ç»†\n`;
        todayLogs.forEach(log => {
            const otcMark = log.isOtcPrice ? '[OTC]' : '';
            const scnMark = log.isScnPrice ? '[SCN]' : '';
            report += `   ${new Date(log.date).toLocaleTimeString()} ${log.trader} ${log.quantity > 0 ? 'ä¹°å…¥' : 'å–å‡º'} ${log.contract} ${Math.abs(log.quantity)} @ ${log.price} ${otcMark}${scnMark}\n`;
        });
    }
    
    if (todayHistory.length > 0) {
        report += `\näº”ã€ä»Šæ—¥å¹³ä»“æ˜ç»†\n`;
        todayHistory.forEach(trade => {
            report += `   ${trade.trader} ${trade.contract} å¹³ä»“${Math.abs(trade.closedQuantity)} å®ç°ç›ˆäº: ${trade.realizedPL.toFixed(2)}\n`;
        });
    }
    
    report += `\n=== æŠ¥å‘Šç»“æŸ ===\n`;
    report += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n`;
    
    document.getElementById('daily-report-content').textContent = report;
    openReportModal();
}

// åˆå§‹åŒ–åˆçº¦é€‰é¡¹
updateContractOptions();
</script>

</body>
</html>
